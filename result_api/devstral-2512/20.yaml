apiVersion: apps/v1
kind: Deployment
metadata:
  name: vod
spec:
  template:
    spec:
      initContainers:
      - name: glowroot-jar-init-container
        image: "your-repo/your-image"
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          runAsNonRoot: true
          readOnlyRootFilesystem: true
        imagePullPolicy: IfNotPresent
        command: ["cp","/opt/tools/aptm/glowroot.jar","/aptm"]
        volumeMounts:
          - name: aptm-data-glowroot
            mountPath: /aptm
      containers:
      - name: vod
        image: "your-repo/com.gtt.ecomp.vod.dev/vod:latest"
        imagePullPolicy: IfNotPresent
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          runAsNonRoot: true
          readOnlyRootFilesystem: true
        command:
          - sh
          - -c
          - -x
          - |
            echo "Copying aptm JAR."
            cp /usr/local/tomcat/webapps/vod/WEB-INF/lib/hram-agent-0.13.jar /opt/tools/aptm;
            bash /mounted-config/start_tomcat.sh;
        args:
          - "30000"
        volumeMounts:
          - name: aptm-data
            mountPath: /opt/tools/aptm
          - name: aptm-data-glowroot
            mountPath: /aptm
      volumes:
        - name: aptm-data
          emptyDir: {}
        - name: aptm-data-glowroot
          emptyDir: {}